<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Gurukul | Register</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Quicksand', sans-serif;
            height: 100vh;
            display: flex; justify-content: center; align-items: center;
            background-image: url('src/loginback.jpg'); background-size: cover;
            background-attachment: fixed;
        }
        .main-container {
            display: flex; width: 1000px; height: 650px;
            background: #ffffff; border-radius: 12px; overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        .left-panel { flex: 1; background: #142A59; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; padding: 20px; text-align: center; }
        .left-panel img { max-width: 85%; margin-bottom: 25px; }
        .right-panel { flex: 1.2; padding: 30px 50px; display: flex; flex-direction: column; overflow-y: auto; }
        .right-panel h1 { color: #142A59; font-size: 1.8rem; margin-bottom: 20px; text-align: center; font-weight: 700; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-group label { display: block; font-size: 0.8rem; font-weight: 700; color: #333; margin-bottom: 4px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; font-family: 'Quicksand', sans-serif; }
        .full-width { grid-column: span 2; }
        
        .verification-area { grid-column: span 2; display: flex; flex-direction: column; align-items: center; margin: 10px 0; }
        .cam-wrapper {
            width: 220px; height: 160px; background: #000; border-radius: 8px;
            position: relative; overflow: hidden; border: 4px solid #ff4d4d;
            transition: all 0.3s ease;
        }
        .cam-wrapper.valid { border-color: #28a745; box-shadow: 0 0 15px rgba(40, 167, 69, 0.4); }
        video, canvas { width: 100%; height: 100%; object-fit: cover; }
        #captured-image { display: none; }

        .cam-btns { margin-top: 10px; display: flex; gap: 10px; }
        .cam-btn { padding: 8px 20px; border-radius: 4px; border: none; font-weight: 700; cursor: pointer; font-size: 0.75rem; }
        #captureBtn { background: #142A59; color: white; opacity: 0.3; pointer-events: none; }
        #captureBtn.enabled { opacity: 1; pointer-events: auto; }
        #recaptureBtn { background: #6c757d; color: white; display: none; }

        .register-btn { width: 100%; padding: 14px; background: #142A59; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: not-allowed; opacity: 0.5; margin-top: 10px; }
        .register-btn.ready { opacity: 1; cursor: pointer; }
        #status-msg { font-size: 0.7rem; margin-top: 5px; font-weight: 600; text-align: center; }
        .footer-info { margin-top: 20px; text-align: center; font-size: 0.85rem; color: #555; }
        .footer-info a { color: #142A59; text-decoration: none; font-weight: 700; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="left-panel">
            <img src="src/login.jpg" alt="Logo">
            <h2>Welcome Back</h2>
            <p>Just a couple of clicks and we start</p>
        </div>
        <div class="right-panel">
            <h1>REGISTER</h1>
            <form id="registerForm">
                <div class="form-grid">
                    <div class="form-group"><label>Role</label><select required><option value="Teacher">Teacher</option><option value="Student">Student</option></select></div>
                    <div class="form-group"><label>Full Name</label><input type="text" placeholder="Full Name" required></div>
                    <div class="form-group full-width"><label>Email ID</label><input type="email" placeholder="email@gmail.com" required></div>
                    <div class="verification-area">
                        <div class="cam-wrapper" id="camWrapper">
                            <video id="video" autoplay playsinline muted></video>
                            <canvas id="captured-image"></canvas>
                        </div>
                        <div class="cam-btns">
                            <button type="button" class="cam-btn" id="captureBtn">CAPTURE</button>
                            <button type="button" class="cam-btn" id="recaptureBtn">RE-CAPTURE</button>
                        </div>
                        <p id="status-msg" style="color:#ff4d4d;">Starting Camera...</p>
                    </div>
                    <div class="form-group"><label>Set Password</label><input type="password" id="pw" required></div>
                    <div class="form-group"><label>Confirm Password</label><input type="password" id="cpw" required></div>
                </div>
                <button type="submit" class="register-btn" id="finalBtn">Register</button>
            </form>
            <div class="footer-info">
                <p>We will notify you when approval is taken.</p>
                <p>Already have an account? <a href="login.html">Login here</a></p>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('captured-image');
        const camWrapper = document.getElementById('camWrapper');
        const captureBtn = document.getElementById('captureBtn');
        const recaptureBtn = document.getElementById('recaptureBtn');
        const finalBtn = document.getElementById('finalBtn');
        const statusMsg = document.getElementById('status-msg');

        let streamObj = null;

        async function startCamera() {
            try {
                streamObj = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = streamObj;
                statusMsg.innerText = "Camera Active - Please center your face";
                statusMsg.style.color = "#555";
                checkFaceAndLight();
            } catch (err) {
                statusMsg.innerText = "Camera Access Denied. Check permissions.";
            }
        }

        function checkFaceAndLight() {
            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d', { willReadFrequently: true });
            tempCanvas.width = 40; 
            tempCanvas.height = 30;

            const checkLoop = setInterval(() => {
                if (video.style.display === 'none' || !streamObj) {
                    clearInterval(checkLoop);
                    return;
                }

                ctx.drawImage(video, 0, 0, 40, 30);
                const frame = ctx.getImageData(0, 0, 40, 30).data;
                
                let brightnessTotal = 0;
                let contrastDiff = 0;

                for (let i = 0; i < frame.length; i += 4) {
                    let avg = (frame[i] + frame[i+1] + frame[i+2]) / 3;
                    brightnessTotal += avg;
                    
                    if (i > 0) {
                        let prevAvg = (frame[i-4] + frame[i-3] + frame[i-2]) / 3;
                        contrastDiff += Math.abs(avg - prevAvg);
                    }
                }

                let finalBrightness = brightnessTotal / (frame.length / 4);
                let finalContrast = contrastDiff / (frame.length / 4);

                // Validation Logic
                if (finalBrightness > 40 && finalContrast > 8) {
                    camWrapper.classList.add('valid');
                    captureBtn.classList.add('enabled');
                    statusMsg.innerText = "Ready to Capture!";
                    statusMsg.style.color = "#28a745";
                } else {
                    camWrapper.classList.remove('valid');
                    captureBtn.classList.remove('enabled');
                    statusMsg.style.color = "#ff4d4d";
                    statusMsg.innerText = finalBrightness < 40 ? "Too dark - need more light" : "Face not centered";
                }
            }, 300);
        }

        captureBtn.addEventListener('click', () => {
            if (!captureBtn.classList.contains('enabled')) return;
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            video.style.display = 'none';
            canvas.style.display = 'block';
            captureBtn.style.display = 'none';
            recaptureBtn.style.display = 'block';
            
            if (streamObj) {
                streamObj.getTracks().forEach(track => track.stop());
            }
            
            statusMsg.innerText = "Identity Captured Successfully!";
            finalBtn.classList.add('ready');
        });

        recaptureBtn.addEventListener('click', () => {
            video.style.display = 'block';
            canvas.style.display = 'none';
            captureBtn.style.display = 'block';
            recaptureBtn.style.display = 'none';
            finalBtn.classList.remove('ready');
            startCamera();
        });

        document.getElementById('registerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if (document.getElementById('pw').value !== document.getElementById('cpw').value) {
                alert("Passwords do not match!"); return;
            }
            finalBtn.innerText = "Reviewing...";
            finalBtn.style.background = "#6c757d";
            setTimeout(() => { finalBtn.innerText = "Submitted for Review"; }, 1500);
        });

        window.onload = startCamera;
    </script>
</body>
</html>